(window.webpackJsonp=window.webpackJsonp||[]).push([[22],{108:function(e,t,a){"use strict";var n=a(0),r=a.n(n),o=a(96),i=a(91),s=a(47),c=a.n(s);const l=37,p=39;t.a=function(e){const{block:t,children:a,defaultValue:s,values:u,groupId:b}=e,{tabGroupChoices:d,setTabGroupChoices:h}=Object(o.a)(),[m,f]=Object(n.useState)(s),[g,O]=Object(n.useState)(!1);if(null!=b){const e=d[b];null!=e&&e!==m&&u.some(t=>t.value===e)&&f(e)}const j=e=>{f(e),null!=b&&h(b,e)},y=[],w=e=>{e.metaKey||e.altKey||e.ctrlKey||O(!0)},v=()=>{O(!1)};return Object(n.useEffect)(()=>{window.addEventListener("keydown",w),window.addEventListener("mousedown",v)},[]),r.a.createElement("div",null,r.a.createElement("ul",{role:"tablist","aria-orientation":"horizontal",className:Object(i.a)("tabs",{"tabs--block":t})},u.map(({value:e,label:t})=>r.a.createElement("li",{role:"tab",tabIndex:0,"aria-selected":m===e,className:Object(i.a)("tabs__item",c.a.tabItem,{"tabs__item--active":m===e}),style:g?{}:{outline:"none"},key:e,ref:e=>y.push(e),onKeyDown:e=>{((e,t,a)=>{switch(a.keyCode){case p:((e,t)=>{const a=e.indexOf(t)+1;e[a]?e[a].focus():e[0].focus()})(e,t);break;case l:((e,t)=>{const a=e.indexOf(t)-1;e[a]?e[a].focus():e[e.length-1].focus()})(e,t)}})(y,e.target,e),w(e)},onFocus:()=>j(e),onClick:()=>{j(e),O(!1)},onPointerDown:()=>O(!1)},t))),r.a.createElement("div",{role:"tabpanel",className:"margin-vert--md"},n.Children.toArray(a).filter(e=>e.props.value===m)[0]))}},109:function(e,t,a){"use strict";var n=a(0),r=a.n(n);t.a=function(e){return r.a.createElement("div",null,e.children)}},83:function(e,t,a){"use strict";a.r(t),a.d(t,"frontMatter",(function(){return c})),a.d(t,"metadata",(function(){return l})),a.d(t,"rightToc",(function(){return p})),a.d(t,"default",(function(){return b}));var n=a(2),r=a(6),o=(a(0),a(89)),i=a(108),s=a(109),c={title:"The Basics"},l={unversionedId:"apps/basics",id:"apps/basics",isDocsHomePage:!1,title:"The Basics",description:"Konstellation works around the App as the master resource. Once you create the apps manifest, it'll be deployed according to specification.",source:"@site/docs/apps/basics.mdx",permalink:"/docs/apps/basics",editUrl:"https://github.com/k11n/konstellation/edit/master/website/docs/apps/basics.mdx",sidebar:"default",previous:{title:"Deploying Your First App",permalink:"/docs/getting-started/deploy"},next:{title:"Config & Environment",permalink:"/docs/apps/configuration"}},p=[{value:"Container registry",id:"container-registry",children:[]},{value:"Targets",id:"targets",children:[]},{value:"Releases",id:"releases",children:[]},{value:"Ports",id:"ports",children:[]},{value:"Ingress",id:"ingress",children:[]},{value:"Setting up SSL",id:"setting-up-ssl",children:[{value:"Testing SSL",id:"testing-ssl",children:[]},{value:"Requiring SSL",id:"requiring-ssl",children:[]}]},{value:"Scaling",id:"scaling",children:[]},{value:"Using AWS IAM roles in apps",id:"using-aws-iam-roles-in-apps",children:[]}],u={rightToc:p};function b(e){var t=e.components,a=Object(r.a)(e,["components"]);return Object(o.b)("wrapper",Object(n.a)({},u,a,{components:t,mdxType:"MDXLayout"}),Object(o.b)("p",null,"Konstellation works around the ",Object(o.b)("inlineCode",{parentName:"p"},"App")," as the master resource. Once you create the ",Object(o.b)("a",Object(n.a)({parentName:"p"},{href:"/docs/reference/manifest"}),"apps manifest"),", it'll be deployed according to specification."),Object(o.b)("p",null,"Behind the scenes, Konstellation operator is creating other resources on Kubernetes and keeping them in sync for you."),Object(o.b)("p",null,"Management of apps is performed via the CLI. The ",Object(o.b)("inlineCode",{parentName:"p"},"kon app")," command will list a number of subcommands that are available to manage apps."),Object(o.b)("p",null,"There are a few considerations and concepts when deploying apps with Konstellation."),Object(o.b)("h2",{id:"container-registry"},"Container registry"),Object(o.b)("p",null,"Apps need to be hosted by a container registry in order to be used with Kubernetes. The ",Object(o.b)("inlineCode",{parentName:"p"},"registry")," field in the app manifest specifies the URL to the registry. When ",Object(o.b)("inlineCode",{parentName:"p"},"registry")," is left blank, it defaults to Docker Hub. By default, the cluster only has access to public repos on Docker Hub. To access private registries, there are a couple of options."),Object(o.b)(i.a,{defaultValue:"ecr",values:[{label:"Amazon ECR",value:"ecr"},{label:"ImagePullSecret",value:"imagepullsecret"}],mdxType:"Tabs"},Object(o.b)(s.a,{value:"ecr",mdxType:"TabItem"},Object(o.b)("p",null,"The simplest option is to use ",Object(o.b)("a",Object(n.a)({parentName:"p"},{href:"https://aws.amazon.com/ecr/"}),"Amazon ECR"),". When Konstellation sets up the IAM role for the cluster, it has read-only access to your repos on ECR."),Object(o.b)("p",null,"Once your images are pushed to ECR, set the ",Object(o.b)("inlineCode",{parentName:"p"},"registry")," field to your ECR URL. That's it.")),Object(o.b)(s.a,{value:"imagepullsecret",mdxType:"TabItem"},Object(o.b)("p",null,"For other private registries, Kubernetes needs to know how to authenticate with them."),Object(o.b)("p",null,"In order to configure this, you'd need to create a ",Object(o.b)("inlineCode",{parentName:"p"},"Secret")," inside Kubernetes and then point to the secret in the ",Object(o.b)("inlineCode",{parentName:"p"},"imagePullSecrets")," field in the app manifest."),Object(o.b)("p",null,"Kubernetes docs has a guide to ",Object(o.b)("a",Object(n.a)({parentName:"p"},{href:"https://kubernetes.io/docs/tasks/configure-pod-container/pull-image-private-registry/"}),"create a secret")," for your registry."),Object(o.b)("p",null,"Since Konstellation creates a namespace for each target that your cluster supports, and Secrets are local to the namespace, you'll need a Secret inside the namespace for each target (which is named the same as the target). For example, if the app has ",Object(o.b)("inlineCode",{parentName:"p"},"production")," as a target, the Secret needs to be created in the ",Object(o.b)("inlineCode",{parentName:"p"},"production")," namespace."),Object(o.b)("p",null,"Once the Secret is created, set the ",Object(o.b)("inlineCode",{parentName:"p"},"imagePullSecrets")," field in the app manifest:"),Object(o.b)("pre",null,Object(o.b)("code",Object(n.a)({parentName:"pre"},{className:"language-yaml"}),"...\nspec:\n  imagePullSecrets:\n    - secretName\n")))),Object(o.b)("h2",{id:"targets"},"Targets"),Object(o.b)("p",null,"Target is a concept in Konstellation that provides a namespace for apps. A target is roughly equivalent to a specific environment of an app. Targets are designed so that you can easily ",Object(o.b)("a",Object(n.a)({parentName:"p"},{href:"https://12factor.net/dev-prod-parity"}),"achieve parity across environments"),". For example, you could specify a production and a development target, with different configurations for hostnames, scale parameters, and even define ",Object(o.b)("a",Object(n.a)({parentName:"p"},{href:"/docs/apps/configuration#target-specific-overrides"}),"target specific app configs"),"."),Object(o.b)("p",null,"Each cluster would define the targets that it supports with ",Object(o.b)("inlineCode",{parentName:"p"},"kon cluster configure"),". When deploying an app to a cluster, it will set up a deployment for each target that the cluster has declared. This configuration allows for the flexibility of using the same ",Object(o.b)("inlineCode",{parentName:"p"},"app.yaml")," across multiple clusters, if you prefer to have dedicated clusters for each target."),Object(o.b)("p",null,"Most target attributes can be defined on the app itself, and when running under that target, they are inherited from the base config. You may choose to override only specific portion of the attributes, and the result would be merged. The only attribute that's target-specific is ",Object(o.b)("inlineCode",{parentName:"p"},"ingress"),". Since ingress is specific to hostnames and exposing traffic to the outside world, it must be defined under the target."),Object(o.b)("p",null,"Konstellation will automatically create a namespace for each target and place all of the native resources under that namespace."),Object(o.b)("p",null,"See ",Object(o.b)("a",Object(n.a)({parentName:"p"},{href:"/docs/reference/manifest#targetconfig"}),"TargetConfig")),Object(o.b)("pre",null,Object(o.b)("code",Object(n.a)({parentName:"pre"},{className:"language-yaml",metastring:'title="App.yaml"',title:'"App.yaml"'}),"apiVersion: k11n.dev/v1alpha1\nkind: App\nmetadata:\n  name: myapp\nspec:\n  image: repo/myapp\n  imageTag: v10\n  ports:\n    - name: http\n      port: 80\n  scale:\n    targetCPUUtilizationPercentage: 60\n    min: 1\n    max: 10\n  targets:\n    - name: staging\n      ingress:\n        hosts:\n          - staging.myapp.com\n        port: http\n      scale:\n        max: 1\n    - name: production\n      ingress:\n        hosts:\n          - www.myapp.com\n        port: http\n      scale:\n        min: 5\n        max: 20\n")),Object(o.b)("p",null,"In this example, the yaml defines two targets, ",Object(o.b)("inlineCode",{parentName:"p"},"staging")," and ",Object(o.b)("inlineCode",{parentName:"p"},"production"),". Note that we override the scale attribute for each target. With the overrides applied, ",Object(o.b)("inlineCode",{parentName:"p"},"staging"),"'s scale attributes would become:"),Object(o.b)("pre",null,Object(o.b)("code",Object(n.a)({parentName:"pre"},{className:"language-yaml"}),"targetCPUUtilizationPercentage: 60\nmin: 1\nmax: 1\n")),Object(o.b)("p",null,Object(o.b)("inlineCode",{parentName:"p"},"production")," scale would be:"),Object(o.b)("pre",null,Object(o.b)("code",Object(n.a)({parentName:"pre"},{className:"language-yaml"}),"targetCPUUtilizationPercentage: 60\nmin: 5\nmax: 20\n")),Object(o.b)("h2",{id:"releases"},"Releases"),Object(o.b)("p",null,"A release is ",Object(o.b)("a",Object(n.a)({parentName:"p"},{href:"https://12factor.net/build-release-run"}),"a base unit of an app's deployment"),". It locks in the app's build along with any configurations. Each change in the app's build or config would trigger a new release to be created. You could list the releases with ",Object(o.b)("inlineCode",{parentName:"p"},"kon app status <yourapp>")),Object(o.b)("p",null,"To deploy a new build, use ",Object(o.b)("inlineCode",{parentName:"p"},"kon app deploy --tag <docker tag> <yourapp>")),Object(o.b)("p",null,"Konstellation would scale up the new release incrementally, and gradually shift over traffic to it. If there's a problem with a particular build or configuration, you could rollback to a prior working release with the ",Object(o.b)("inlineCode",{parentName:"p"},"kon app rollback")," command. Rollback marks a particular release as bad, and will cause the system to automatically deploy the previous working version."),Object(o.b)("h2",{id:"ports"},"Ports"),Object(o.b)("p",null,"Ports are ",Object(o.b)("a",Object(n.a)({parentName:"p"},{href:"https://12factor.net/port-binding"}),"the way")," to enable your app to serve requests from other apps, and the internet at large."),Object(o.b)("p",null,"In Konstellation, ports are required to have a name, and those names are used to reference that port in Ingress as well as ",Object(o.b)("a",Object(n.a)({parentName:"p"},{href:"/docs/apps/services#connecting-to-services"}),"app dependencies"),"."),Object(o.b)("p",null,"The port number can be whichever that the app wants to listen on. There will not be any collision issues with other apps that might use the same port, due to the way ",Object(o.b)("a",Object(n.a)({parentName:"p"},{href:"https://kubernetes.io/docs/concepts/cluster-administration/networking/#the-kubernetes-network-model"}),"Kubernetes' networking layer is designed"),"."),Object(o.b)("h2",{id:"ingress"},"Ingress"),Object(o.b)("p",null,"If the app needs to be surfaced to the internet, you'd want to declare an ",Object(o.b)("a",Object(n.a)({parentName:"p"},{href:"/docs/reference/manifest#ingressconfig"}),"Ingress")," in order to create a load balancer."),Object(o.b)("p",null,"In the Ingress config, list all of the domains that you wish the load balancer to handle. Konstellation will manage a AWS ALB and configure it to listen for all the traffic for your domains. With Ingress, the public port it surfaces will always be 80 for HTTP and 443 for HTTPS."),Object(o.b)("p",null,"Once created, you can get the address of the load balancer with ",Object(o.b)("inlineCode",{parentName:"p"},"kon app status <yourapp>"),". Then, set up an ALIAS or CNAME with your DNS provider pointing the domain to that address."),Object(o.b)("p",null,"To test the app before changing DNS, you can run"),Object(o.b)("pre",null,Object(o.b)("code",Object(n.a)({parentName:"pre"},{}),'curl -H "Host: yourhost.com" <load balancer address>\n')),Object(o.b)("h2",{id:"setting-up-ssl"},"Setting up SSL"),Object(o.b)("p",null,"On EKS, Konstellation uses an ",Object(o.b)("a",Object(n.a)({parentName:"p"},{href:"https://aws.amazon.com/elasticloadbalancing/features/"}),"Application Load Balancer (ALB)")," for ingress. ALB is a layer 7 load balancer and is capable of terminating SSL/TLS requests."),Object(o.b)("p",null,"Because the termination is handled by ALB, Konstellation (or Kubernetes) does not need your certificate nor private key. This creates a secure setup since we no longer have to worry about securing Kubernetes' key storage. As long as your certificates are stored in ACM, Konstellation needs only a reference to them."),Object(o.b)("p",null,"To use SSL with Konstellation, first ensure your certificate is uploaded into ",Object(o.b)("a",Object(n.a)({parentName:"p"},{href:"https://console.aws.amazon.com/acm/home"}),"ACM"),", then sync certificate references into Kubernetes with:"),Object(o.b)("pre",null,Object(o.b)("code",Object(n.a)({parentName:"pre"},{className:"language-text"}),"% kon certificate sync\n")),Object(o.b)("p",null,"After the sync, the app will be available via HTTPS as well. Note: ACM is region aware, your cluster and certificates must reside in the same region as the cluster for them to be usable."),Object(o.b)("h3",{id:"testing-ssl"},"Testing SSL"),Object(o.b)("p",null,"Before DNS of the hosts are pointed to the Konstellation load balancer, it can be tricky to test HTTPS traffic with curl. This is because the certificate used does not match the host of the load balancer. To get around this, use curl's ",Object(o.b)("inlineCode",{parentName:"p"},"resolve")," flag:"),Object(o.b)("pre",null,Object(o.b)("code",Object(n.a)({parentName:"pre"},{}),'% host=<your host>\ntarget=<load balancer address>\nip=$(dig +short ${target} | head -n1)\ncurl -sv --resolve "${host}:443:${ip}" "https://${host}"\n')),Object(o.b)("h3",{id:"requiring-ssl"},"Requiring SSL"),Object(o.b)("p",null,"When HTTPS is confirmed to work, you could also disable insecure connections to your app. This can be done by setting a flag on the ",Object(o.b)("a",Object(n.a)({parentName:"p"},{href:"/docs/reference/manifest#ingressconfig"}),"IngressConfig"),". When set, Konstellation will issue a 301 redirect for all plain HTTP traffic to its HTTPS equivalent."),Object(o.b)("pre",null,Object(o.b)("code",Object(n.a)({parentName:"pre"},{className:"language-yaml",metastring:'title="app.yaml"',title:'"app.yaml"'}),"...\n  target:\n    production:\n      ingress:\n        requireHttps: true\n")),Object(o.b)("h2",{id:"scaling"},"Scaling"),Object(o.b)("p",null,"Konstellation supports autoscaling out of the box, and will manage a ",Object(o.b)("a",Object(n.a)({parentName:"p"},{href:"https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale/"}),"Horizontal Pod Autoscaler")," based on configuration. Depending on the specified resource usage, your app will scale up and down in the number of pods to meet demand."),Object(o.b)("p",null,"In order to use autoscaling, you'd have to declare a few attributes in the app manifest:"),Object(o.b)("ul",null,Object(o.b)("li",{parentName:"ul"},Object(o.b)("a",Object(n.a)({parentName:"li"},{href:"/docs/reference/manifest#scalespec"}),Object(o.b)("strong",{parentName:"a"},"scale")),": You need to set the ",Object(o.b)("inlineCode",{parentName:"li"},"min"),", ",Object(o.b)("inlineCode",{parentName:"li"},"max"),", and ",Object(o.b)("inlineCode",{parentName:"li"},"targetCPUUtilizationPercentage")),Object(o.b)("li",{parentName:"ul"},Object(o.b)("a",Object(n.a)({parentName:"li"},{href:"/docs/reference/manifest#resource-requirements"}),Object(o.b)("strong",{parentName:"a"},"resources")),": Both ",Object(o.b)("inlineCode",{parentName:"li"},"requests")," and ",Object(o.b)("inlineCode",{parentName:"li"},"limits")," need to be set")),Object(o.b)("h2",{id:"using-aws-iam-roles-in-apps"},"Using AWS IAM roles in apps"),Object(o.b)("p",null,"Konstellation could can take full advantage of IAM roles when running apps. By default, all of the apps are ran with the same role as the EKS node, which is set up with a minimal set of permissions."),Object(o.b)("p",null,"Kubernetes supports role based access control (RBAC) with Service Accounts. It works wonderfully in handling the identity of the app automatically. However, Service Accounts are designed to control access within Kubernetes itself, and is not connected to the AWS role in any way."),Object(o.b)("p",null,"In order to make this work simply in a reproducible manner, Konstellation supports an extension of service accounts: ",Object(o.b)("a",Object(n.a)({parentName:"p"},{href:"/docs/reference/linkedserviceaccount"}),"Linked Service Account")," that links IAM policies to a Kubernetes service account."),Object(o.b)("p",null,"Once you've created a Linked Service Account, set it in the app manifest's ",Object(o.b)("inlineCode",{parentName:"p"},"serviceAccount")," field. A new deployment of the app will be created that assumes the permissions of the linked service account."),Object(o.b)("p",null,Object(o.b)("strong",{parentName:"p"},"Limitations")),Object(o.b)("p",null,"Your app needs to be using one of the ",Object(o.b)("a",Object(n.a)({parentName:"p"},{href:"https://docs.aws.amazon.com/eks/latest/userguide/iam-roles-for-service-accounts-minimum-sdk.html"}),"supported AWS SDKs")," in order to make use of linked service accounts."))}b.isMDXComponent=!0},89:function(e,t,a){"use strict";a.d(t,"a",(function(){return u})),a.d(t,"b",(function(){return h}));var n=a(0),r=a.n(n);function o(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function i(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function s(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?i(Object(a),!0).forEach((function(t){o(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):i(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function c(e,t){if(null==e)return{};var a,n,r=function(e,t){if(null==e)return{};var a,n,r={},o=Object.keys(e);for(n=0;n<o.length;n++)a=o[n],t.indexOf(a)>=0||(r[a]=e[a]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(n=0;n<o.length;n++)a=o[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(r[a]=e[a])}return r}var l=r.a.createContext({}),p=function(e){var t=r.a.useContext(l),a=t;return e&&(a="function"==typeof e?e(t):s(s({},t),e)),a},u=function(e){var t=p(e.components);return r.a.createElement(l.Provider,{value:t},e.children)},b={inlineCode:"code",wrapper:function(e){var t=e.children;return r.a.createElement(r.a.Fragment,{},t)}},d=r.a.forwardRef((function(e,t){var a=e.components,n=e.mdxType,o=e.originalType,i=e.parentName,l=c(e,["components","mdxType","originalType","parentName"]),u=p(a),d=n,h=u["".concat(i,".").concat(d)]||u[d]||b[d]||o;return a?r.a.createElement(h,s(s({ref:t},l),{},{components:a})):r.a.createElement(h,s({ref:t},l))}));function h(e,t){var a=arguments,n=t&&t.mdxType;if("string"==typeof e||n){var o=a.length,i=new Array(o);i[0]=d;var s={};for(var c in t)hasOwnProperty.call(t,c)&&(s[c]=t[c]);s.originalType=e,s.mdxType="string"==typeof e?e:n,i[1]=s;for(var l=2;l<o;l++)i[l]=a[l];return r.a.createElement.apply(null,i)}return r.a.createElement.apply(null,a)}d.displayName="MDXCreateElement"},91:function(e,t,a){"use strict";function n(e){var t,a,r="";if("string"==typeof e||"number"==typeof e)r+=e;else if("object"==typeof e)if(Array.isArray(e))for(t=0;t<e.length;t++)e[t]&&(a=n(e[t]))&&(r&&(r+=" "),r+=a);else for(t in e)e[t]&&(r&&(r+=" "),r+=t);return r}t.a=function(){for(var e,t,a=0,r="";a<arguments.length;)(e=arguments[a++])&&(t=n(e))&&(r&&(r+=" "),r+=t);return r}},95:function(e,t,a){"use strict";var n=a(0);const r=Object(n.createContext)(void 0);t.a=r},96:function(e,t,a){"use strict";var n=a(0),r=a(95);t.a=function(){const e=Object(n.useContext)(r.a);if(null==e)throw new Error("`useUserPreferencesContext` is used outside of `Layout` Component.");return e}}}]);