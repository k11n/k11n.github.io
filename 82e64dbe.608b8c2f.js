(window.webpackJsonp=window.webpackJsonp||[]).push([[12],{71:function(e,t,r){"use strict";r.r(t),r.d(t,"frontMatter",(function(){return i})),r.d(t,"metadata",(function(){return c})),r.d(t,"rightToc",(function(){return p})),r.d(t,"default",(function(){return s}));var n=r(2),a=r(6),o=(r(0),r(89)),i={title:"Cluster Migration"},c={unversionedId:"clusters/migration",id:"clusters/migration",isDocsHomePage:!1,title:"Cluster Migration",description:"The following is a guide to migrating from an existing Konstellation cluster to a new one. For the purpose of the guide, it uses Route53 as the example DNS provider.",source:"@site/docs/clusters/migration.md",permalink:"/docs/clusters/migration",editUrl:"https://github.com/k11n/konstellation/edit/master/website/docs/clusters/migration.md",sidebar:"default",previous:{title:"Upgrading",permalink:"/docs/clusters/upgrading"},next:{title:"App Manifest",permalink:"/docs/reference/manifest"}},p=[],l={rightToc:p};function s(e){var t=e.components,r=Object(a.a)(e,["components"]);return Object(o.b)("wrapper",Object(n.a)({},l,r,{components:t,mdxType:"MDXLayout"}),Object(o.b)("p",null,"The following is a guide to migrating from an existing Konstellation cluster to a new one. For the purpose of the guide, it uses Route53 as the example DNS provider."),Object(o.b)("ol",null,Object(o.b)("li",{parentName:"ol"},Object(o.b)("p",{parentName:"li"},"Export a backup of Konstellation manifests"),Object(o.b)("pre",{parentName:"li"},Object(o.b)("code",Object(n.a)({parentName:"pre"},{}),"kon cluster export --dir <export_dir>\n"))),Object(o.b)("li",{parentName:"ol"},Object(o.b)("p",{parentName:"li"},"Create a new cluster with desired settings"),Object(o.b)("pre",{parentName:"li"},Object(o.b)("code",Object(n.a)({parentName:"pre"},{}),"% kon cluster create\n")),Object(o.b)("p",{parentName:"li"},"Choose the same VPC as the previous cluster to minimize descrepencies in the networking setup.")),Object(o.b)("li",{parentName:"ol"},Object(o.b)("p",{parentName:"li"},"Select the new cluster to work with"),Object(o.b)("pre",{parentName:"li"},Object(o.b)("code",Object(n.a)({parentName:"pre"},{}),"% kon cluster select <newcluster>\n"))),Object(o.b)("li",{parentName:"ol"},Object(o.b)("p",{parentName:"li"},"Sync SSL certs"),Object(o.b)("pre",{parentName:"li"},Object(o.b)("code",Object(n.a)({parentName:"pre"},{}),"% kon certificate sync\n"))),Object(o.b)("li",{parentName:"ol"},Object(o.b)("p",{parentName:"li"},"Import configuration into new cluster"),Object(o.b)("pre",{parentName:"li"},Object(o.b)("code",Object(n.a)({parentName:"pre"},{}),"% kon cluster import --dir <export_dir>\n")),Object(o.b)("p",{parentName:"li"},"This will import all of your existing apps, builds, configs, and linked accounts into the new cluster, creating the necessary IAM roles as defined by the linked accounts."),Object(o.b)("p",{parentName:"li"},"Optional: If you've made other changes to the existing Kubernetes cluster, apply those changes to the new cluster as well.")),Object(o.b)("li",{parentName:"ol"},Object(o.b)("p",{parentName:"li"},"Check your apps to ensure everything's running correctly"),Object(o.b)("pre",{parentName:"li"},Object(o.b)("code",Object(n.a)({parentName:"pre"},{}),"% kon app list\n")),Object(o.b)("p",{parentName:"li"},"All apps should have Status ",Object(o.b)("inlineCode",{parentName:"p"},"running")," if they are deployed properly.")),Object(o.b)("li",{parentName:"ol"},Object(o.b)("p",{parentName:"li"},"Get new load balancer address for the entrypoint app"),Object(o.b)("pre",{parentName:"li"},Object(o.b)("code",Object(n.a)({parentName:"pre"},{}),"% kon app status <main_app>\n\nTarget: production\nHosts: www.myhost.com\nLoad Balancer: ff833335-istiosystem-konin-xxxxxxx.us-west-2.elb.amazonaws.com\n")),Object(o.b)("p",{parentName:"li"}," and test to ensure that the route to your app is working"),Object(o.b)("pre",{parentName:"li"},Object(o.b)("code",Object(n.a)({parentName:"pre"},{}),'% host=<your host>\ntarget=<load balancer address>\nip=$(dig +short ${target} | head -n1)\ncurl -sv --resolve "${host}:443:${ip}" "https://${host}"\n'))),Object(o.b)("li",{parentName:"ol"},Object(o.b)("p",{parentName:"li"},"Change the routing policy on the existing DNS entry to be ",Object(o.b)("inlineCode",{parentName:"p"},"Weighted")," in order to move traffic over to the new cluster gradually. If you are using IPv6, do the same for the AAAA entry."),Object(o.b)("img",{src:"/img/screen/migration-1.png",alt:"change routing policy",style:{width:"400px"}})),Object(o.b)("li",{parentName:"ol"},Object(o.b)("p",{parentName:"li"},"Create a new DNS entry with the same name, choose ",Object(o.b)("inlineCode",{parentName:"p"},"Weighted")," routing policy and give it a weight of 1. Hit create, and now ~1% of your site's traffic will be sent to the new cluster."),Object(o.b)("img",{src:"/img/screen/migration-2.png",alt:"add new DNS entry",style:{width:"400px"}})),Object(o.b)("li",{parentName:"ol"},Object(o.b)("p",{parentName:"li"},"Check traffic on Grafana and ensure things look right"),Object(o.b)("pre",{parentName:"li"},Object(o.b)("code",Object(n.a)({parentName:"pre"},{}),"% kon launch grafana\n")),Object(o.b)("p",{parentName:"li"},"Navigate to the ",Object(o.b)("inlineCode",{parentName:"p"},"App Overview")," dashboard and select the app that should be receiving traffic. You should see traffic ramping up."),Object(o.b)("p",{parentName:"li"},Object(o.b)("img",Object(n.a)({parentName:"p"},{src:"/img/screen/migration-3.png",alt:"grafana"})))),Object(o.b)("li",{parentName:"ol"},Object(o.b)("p",{parentName:"li"},"Increase the weight of the new cluster gradually, to ensure that autoscalers would have a chance to catch up with getting the right number of instances of pods. Once traffic is fully shifted over to the new cluster, you can delete the DNS entries of the old cluster.")),Object(o.b)("li",{parentName:"ol"},Object(o.b)("p",{parentName:"li"},"Destroy the existing cluster with ",Object(o.b)("inlineCode",{parentName:"p"},"kon cluster destroy --cluster <old_cluster>")))))}s.isMDXComponent=!0},89:function(e,t,r){"use strict";r.d(t,"a",(function(){return b})),r.d(t,"b",(function(){return d}));var n=r(0),a=r.n(n);function o(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function i(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function c(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?i(Object(r),!0).forEach((function(t){o(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):i(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function p(e,t){if(null==e)return{};var r,n,a=function(e,t){if(null==e)return{};var r,n,a={},o=Object.keys(e);for(n=0;n<o.length;n++)r=o[n],t.indexOf(r)>=0||(a[r]=e[r]);return a}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(n=0;n<o.length;n++)r=o[n],t.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(a[r]=e[r])}return a}var l=a.a.createContext({}),s=function(e){var t=a.a.useContext(l),r=t;return e&&(r="function"==typeof e?e(t):c(c({},t),e)),r},b=function(e){var t=s(e.components);return a.a.createElement(l.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return a.a.createElement(a.a.Fragment,{},t)}},m=a.a.forwardRef((function(e,t){var r=e.components,n=e.mdxType,o=e.originalType,i=e.parentName,l=p(e,["components","mdxType","originalType","parentName"]),b=s(r),m=n,d=b["".concat(i,".").concat(m)]||b[m]||u[m]||o;return r?a.a.createElement(d,c(c({ref:t},l),{},{components:r})):a.a.createElement(d,c({ref:t},l))}));function d(e,t){var r=arguments,n=t&&t.mdxType;if("string"==typeof e||n){var o=r.length,i=new Array(o);i[0]=m;var c={};for(var p in t)hasOwnProperty.call(t,p)&&(c[p]=t[p]);c.originalType=e,c.mdxType="string"==typeof e?e:n,i[1]=c;for(var l=2;l<o;l++)i[l]=r[l];return a.a.createElement.apply(null,i)}return a.a.createElement.apply(null,r)}m.displayName="MDXCreateElement"}}]);